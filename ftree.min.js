function familyTree(e,t){function L(){var e=[];for(var t=0;t!=this.generations.length;t++){for(var n=0;n!=this.generations[t].length;n++){e.push(this.generations[t][n])}}return e}function A(e){var t=[],n=[];if(!e){return false}if(!e.isArray){e=[e]}if(e.length===0){return[]}if(e.length===1){return[e]}for(var r=0;r!=e.length;r++){if(e[r].father){break}}if(r===e.length){var i=e[0]}else{var i=e[r]}var s=i;while(s.father&&e.indexOf(s.father)!==-1){s=s.father}t.push(s);for(var r=0;r!=s.partners.length;r++){partner=s.partners[r].person;if(s.partners[r]&&e.indexOf(partner)!==-1){t.push(partner)}}n.push(t);t=[];children=P(s,e);var o,u=[],a;while(children.length>0){o=[];for(var r=0;r!=children.length;r++){if(t.indexOf(children[r])===-1){t.push(children[r])}partners=children[r].partners;for(var f=0;f!=partners.length;f++){partner=partners[f].person;if(partner&&e.indexOf(partner)!==-1){if(children.indexOf(partner)===-1){if(t.indexOf(partner)===-1){t.push(partner)}u=P(children[r],e);for(var l=0;l!=u.length;l++){if(o.indexOf(u[l])===-1){o.push(u[l])}}}}}}n.push(t);t=[];children=o}var c=0,h=0,p=0,d=false;while(h<e.length){found_this_time=false;s=e[c];if(H(s,n)===-1){siblings=M(s,e);for(var r=0;r!=siblings.length;r++){sibling=siblings[r];if(H(sibling,n)!==-1){generation_index=B(sibling,n);if(n[generation_index].indexOf(s)===-1){n[generation_index].push(s)}found_this_time=true;break}}if(!found_this_time){for(var f=0;f<s.partners.length;f++){partner=s.partners[f].person;if(partner){if(H(partner,n)!==-1){generation_index=B(partner,n);if(n[generation_index].indexOf(s)===-1){n[generation_index].push(s)}found_this_time=true}}}}if(!found_this_time){father=s.father;if(father){if(H(father,n)!==-1){generation_index=B(father,n);if(generation_index===n.length-1){n.push([s])}else{n[generation_index+1].push(s)}found_this_time=true}}}if(!found_this_time){children=P(s,e);for(var r=0;r!=children.length;r++){a=children[r];if(H(a,n)!==-1){generation_index=B(a,n);if(generation_index>0){n[generation_index-1].push(s)}else{n.splice(0,0,[s])}found_this_time=true;break}}}if(found_this_time){h++;d=true}}c++;if(c>e.length-1){c=0;p++;if(p>1){if(!d){break}}d=false}}return n}function O(e,t,n){var r=null,i=null,s=[],o=[],u=[];if(e){r=e;if(t){Q(r,t);Q(t,r);o.push(t)}else{if(r.active_partner){Q(r.active_partner.person,r);o.push(r.active_partner.person)}}}else{r=n[0];if(r.active_partner){Q(r.active_partner.person,r);o.push(r.active_partner.person)}}o.push(r);if(r.father&&r.mother){u=_(r,n);for(var a=0;a<u.length;a++){if(o.indexOf(u[a])===-1){o.push(u[a])}}}while(o.length>0){p=o.pop();if(s.indexOf(p)===-1){s.push(p);if(p.father){if(o.indexOf(p.father)===-1){o.push(p.father)}}if(p.mother){if(o.indexOf(p.mother)===-1){o.push(p.mother)}}if(p.father&&p.mother){Q(p.father,p.mother);Q(p.mother,p.father)}u=_(p,n);for(var a=0;a<u.length;a++){if(o.indexOf(u[a])===-1){o.push(u[a])}}if(p!==t&&p.active_partner){if(o.indexOf(i)===-1){i=p.active_partner.person;Q(i,p);o.push(i)}}}}var f=D(r,n);for(var a=0;a<f.length;a++){o.push(f[a])}while(o.length>0){p=o.pop();if(s.indexOf(p)===-1){s.push(p);if(p.active_partner){if(!p.partner_processed){if(o.indexOf(p.active_partner.person)===-1){var l=p.active_partner.person;l.partner_processed=true;Q(l,p);o.push(l)}}if(p.active_partner.person.father){if(o.indexOf(p.active_partner.person)===-1){o.push(p.active_partner.person.father)}}if(p.active_partner.person.mother){if(o.indexOf(p.active_partner.person.mother)===-1){o.push(p.active_partner.person.mother)}}u=M(p.active_partner.person,n);for(var a=0;a<u.length;a++){if(o.indexOf(u[a])===-1){o.push(u[a])}}}children2=D(p,n);for(var a=0;a<children2.length;a++){if(o.indexOf(children2[a])===-1){o.push(children2[a])}}}}return s}function M(e,t){var n=[],r;if(e.father||e.mother){for(var i=0;i!=t.length;i++){r=false;if(t[i].father&&e.father){if(t[i].father===e.father){r=true}}if(t[i].mother&&e.mother){if(t[i].mother===e.mother){r=true}}if(r&&t[i].id!==e.id){n.push(t[i])}}}return n}function _(e,t){var n=[];if(e.father&&e.mother){for(var r=0;r!=t.length;r++){if(t[r].father&&t[r].mother){if(t[r].father===e.father&&t[r].mother===e.mother){if(t[r].id!==e.id){n.push(t[r])}}}}}return n}function D(e,t){var n=[];if(e.active_partner){for(var r=0;r!=t.length;r++){if(t[r].father===e&&t[r].mother===e.active_partner.person||t[r].father===e.active_partner.person&&t[r].mother===e){n.push(t[r])}}}return n}function P(e,t){var n=[];for(var r=0;r!=t.length;r++){if(t[r].father===e||t[r].mother===e){n.push(t[r])}}return n}function H(e,t){var n;if(t[0].isArray){for(var r=0;r!=t.length;r++){n=t[r].indexOf(e);if(n!==-1){return n}}}else{n=t.indexOf(e);if(n!==-1){return n}}return-1}function B(e,t){var n;for(var r=0;r!=t.length;r++){n=t[r].indexOf(e);if(n!=-1){return r}}return-1}function j(){var t;for(var n=0;n<e.length;n++){for(var r=0;r<e[n].partners.length;r++){t=e[n].partners[r].person;if(t){var i=false;for(var s=0;s<t.partners.length;s++){if(t.partners[s].person===e[n]){i=true;break}}if(!i){t.partners.push({person:e[n]})}}}}}function F(e,t){var n=[e.father,e.mother];for(var r=0;r!=e.partners.length;r++){n.push(e.partners[r].person)}for(var r=0;r!=n.length;r++){if(n[r]){if(q(n[r])){for(var i=0;i!=t.length;i++){if(t[i].id===n[r]){switch(r){case 0:e.father=t[i];break;case 1:e.mother=t[i];break;default:e.partners[r-2].person=t[i];break}break}}}}}}function I(t,n){var r=null,i=null;if(t){if(q(t)){for(var s=0;s!=e.length;s++){if(e[s].id===t){r=e[s];break}}}else{r=t}}if(n){if(q(n)){for(var s=0;s!=e.length;s++){if(e[s].id===n){i=e[s];break}}}else{i=n}}return{active_person:r,active_partner:i}}function q(e){return!isNaN(e)&&parseInt(Number(e))==e&&!isNaN(parseInt(e,10))}function R(e){var t,n;for(var r=0;r<e.generations.length;r++){for(var i=0;i<e.generations[r].length;i++){n=e.generations[r][i];if(n.partners.length>0){partner=n.active_partner.person;if(n.father&&n.mother&&partner.father&&partner.mother){place_person=H(n,e.generations);place_partner=H(partner,e.generations);place_father=H(n.father,e.generations);place_father_partner=H(partner.father,e.generations);if(place_father>place_person&&place_father_partner<place_partner){t=e.generations[r-1][place_father];e.generations[r-1][place_father]=e.generations[r-1][place_father_partner];e.generations[r-1][place_father_partner]=t;t=e.generations[r-1][place_father+1];e.generations[r-1][place_father+1]=e.generations[r-1][place_father_partner+1];e.generations[r-1][place_father_partner+1]=t}}}}}}function U(e){var t,n;for(var r=0;r<e.generations.length;r++){for(var i=0;i<e.generations[r].length;i++){n=e.generations[r][i];if(n.gender=="male"){if(n.partners.length>0){if(n.active_partner){last_partner=n.active_partner.person}else{last_partner=n.last_partner.person}place_male=H(n,e.generations);place_female=H(last_partner,e.generations);if(place_male>place_female&&place_female!==-1&&place_male!==-1){if(place_male-place_female===1){t=e.generations[r][i];e.generations[r][i]=e.generations[r][i-1];e.generations[r][i-1]=t}else{t=e.generations[r][place_female];e.generations[r][place_female]=e.generations[r][place_male];for(var s=0;s<place_male-place_female;s++){e.generations[r][place_male-s]=e.generations[r][place_male-s-1]}e.generations[r][place_female+1]=t}}}}}}}function z(e){partners=[];for(var t=0;t<e.partners.length;t++){partners.push(e.partners[t])}return partners[partners.length-1]}function W(e,t){return e.sort(function(e,n){var r=e[t];var i=n[t];return r<i?-1:r>i?1:0})}function X(t,n,r){J(t,n);var i=O(t,n,e);r.generations=A(i);U(r);R(r);r.show()}function V(e){e.color=t.color||n;e.fillColor=t.fillColor||r;e.maleFillColor=t.maleFillColor||i;e.femaleFillColor=t.femaleFillColor||s;e.strokeColor=t.strokeColor||l;e.maleBorderColor=t.maleBorderColor||o;e.femaleBorderColor=t.femaleBorderColor||u;e.blur=t.blur||E;if(t.radius===undefined){e.radius=S}else{e.radius=t.radius}e.strokeWidth=t.strokeWidth||c;e.mouseoverColor=t.mouseoverColor||h;e.width=t.width||m;e.height=t.height||g;e.startX=t.startX||d;e.startY=t.startY||v;e.fontSize=t.fontSize||w;e.vDistance=t.vDistance||y;e.hDistance=t.hDistance||b;e.onClick=t.onClick||function(){};e.getText=t.getText;e.mouseoverMaleBorderColor=t.mouseoverMaleBorderColor||a;e.mouseoverFemaleBorderColor=t.mouseoverFemaleBorderColor||f;var p=I(t.active_person,t.active_partner);e.active_person=p.active_person||x;e.active_partner=p.active_partner||T}function $(e){var t=e.femaleFillColor;var n=e.maleFillColor;var r=e.fillColor;var i=e.maleBorderColor;var s=e.femaleBorderColor;var o=e.mouseoverColor;var u=e.mouseoverMaleBorderColor;var a=e.mouseoverFemaleBorderColor;e.onmouseover=function(){switch(this.data.person.gender){case"male":this.data.node.attr({fill:o,stroke:u});break;case"female":this.data.node.attr({fill:o,stroke:a});break;default:this.data.node.attr({fill:o})}};e.onmouseout=function(){switch(this.data.person.gender){case"male":this.data.node.attr({fill:n,stroke:i});break;case"female":this.data.node.attr({fill:t,stroke:s});break;default:this.data.node.attr({fill:r})}}}function J(t,n){for(var r=0;r<e.length;r++){if(e[r].partners.length>0){e[r].last_partner=z(e[r]);e[r].active_partner=e[r].last_partner}}if(t&&n){Q(t,n);Q(n,t)}}function K(e){if(e&&e.partners.length>0){var t=[];for(var n=0;n<e.partners.length;n++){t.push(e.partners[n].person)}return t}}function Q(e,t){var n=false;if(e&&t){if(e.partners.length>1){for(var r=0;r<e.partners.length;r++){if(e.partners[r].person==t){e.active_partner=e.partners[r];n=true;break}}if(n===false){console.log("Error in setting partners: partner not found: "+e.active_partner.person.first_name)}}}else{if(e.partners.length!==1){console.log("Error in setting partners: something is missing");console.log(e.first_name);console.log(e.partners.length);console.log(t.first_name)}}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(e,t){if(t==null){t=0}else if(t<0){t=Math.max(0,this.length+t)}for(var n=t,r=this.length;n<r;n++){if(this[n]===e)return n}return-1}}Array.prototype.isArray=true;var n="#111",r="#eee",i="#57aaf7",s="#f2bbc4",o="#F00",u="#00F",a="#000",f="#000",l="#000",c=2,h="#ddd",d=100,v=100,m=150,g=150,y=100,b=100,w="14",E=false,S=20,x=null,T=null;this.generations=[];for(var N=0;N!=e.length;N++){if(!e[N].partners){e[N].partners=[]}F(e[N],e)}j();V(this);J();var C=O(this.active_person,this.active_partner,e);var k=A(C);if(k){this.generations=k}else{return false}U(this);R(this);if(this.generations.length===0){return false}this.canvas=null;$(this);this.hide=function(){if(this.canvas){this.canvas.remove();for(var e=0;e!=this.generations.length;e++){for(var t=0;t!=this.generations[e].length;t++){if(this.generations[e][t].node){this.generations[e][t].node.node.remove();this.generations[e][t].node.text.remove()}}}}};this.remove=function(e){if(!e){console.log("trying to remove undefined or null");return 0}var t=L.call(this);if(e.isArray){if(e.length===0){console.log("trying to remove an empty array");return 0}}else{e=[e]}var n,r=0;for(var i=0;i!=e.length;i++){n=t.indexOf(e[i]);if(n!==-1){t.splice(n,1);r++}else{console.log("trying to remove a non-existing person")}}var s=A(t);this.generations=s;return r};this.append=function(e){if(!e){console.log("trying to append undefined or null");return 0}var t=L.call(this);if(e.isArray){if(e.length===0){console.log("trying to append an empty array");return 0}}else{e=[e]}for(var n=0;n!=e.length;n++){t.push(e[n])}this.generations=A(t);return e.length};this.show=function(){function g(e,t,n,r,i,s){var o,u;var a=this.canvas.rect(e,t,n,r,this.radius);var f=this.canvas.text(e+n/2,t+r/2-10,this.getText(i));f.attr("font-size",this.fontSize);switch(i.gender){case"male":o=this.maleFillColor;u=this.maleBorderColor;break;case"female":o=this.femaleFillColor;u=this.femaleBorderColor;break;default:o=this.fillColor;u=this.color}a.attr({fill:o,stroke:u,translation:"4,4",text:f});if(this.blur){a.blur(1)}var l=this.onClick;a.text=f;a.person=i;a.click(function(){l(i)});a.data={node:a,person:i};f.click(function(){l(i)});f.data={node:a,person:i};return{node:a,text:f}}var e=[],t=[],n=[],r=1,i=this.generations,s,o,u,a,f=[],l=this;for(var c=0;c!=i.length;c++){t.push(i[c].length)}r=Math.max.apply(0,t);for(var c=0;c!=i.length;c++){if(i[c].length>1){n.push(i[c][1].partners.length)}else{n.push(0)}}for(var c=0;c!=i.length;c++){e[c]=20*n[c]+(this.width+this.hDistance)/2*(r-i[c].length)}if(this.canvas){this.hide()}this.canvas=Raphael(this.startX,this.startY,r*(this.width+this.hDistance)+20,(i.length+1)*(this.height+this.vDistance)+20);for(var c=0;c!=i.length;c++){for(var h=0;h!=i[c].length;h++){o=e[c]+h*(this.width+this.hDistance);u=c*(this.height+this.vDistance)+20;this.generations[c][h].node=g.call(this,o,u,this.width,this.height,this.generations[c][h],"");i[c][h].node.node.mouseover(this.onmouseover);i[c][h].node.node.mouseout(this.onmouseout);i[c][h].node.text.mouseover(this.onmouseover);i[c][h].node.text.mouseout(this.onmouseout);if(i[c][h].partners.length>1){var p=this.generations[c][h].node.node.click;this.generations[c][h].node.node.click(function(){p();this.toFront();this.text.toFront();X(this.person,null,l)});var d=1;for(var v=i[c][h].partners.length-1;v>=0;v--){if(i[c][h].partners[v].person!==i[c][h].active_partner.person){if(this.generations[c][h].gender=="male"){this.generations[c][h].partners[v].node=g.call(this,o+this.width+this.hDistance-15*d,u-15*d,this.width,this.height,this.generations[c][h].partners[v].person,"")}else{this.generations[c][h].partners[v].node=g.call(this,o-this.width-this.hDistance-15*d,u-15*d,this.width,this.height,this.generations[c][h].partners[v].person,"");this.generations[c][h].partners[v].node.node.toBack();this.generations[c][h].partners[v].node.text.toBack()}var m=this.generations[c][h];this.generations[c][h].partners[v].node.node.mouseover(this.onmouseover);this.generations[c][h].partners[v].node.node.mouseout(this.onmouseout);this.generations[c][h].partners[v].node.text.mouseover(this.onmouseover);this.generations[c][h].partners[v].node.text.mouseout(this.onmouseout);this.generations[c][h].partners[v].node.node.active_partner=m;this.generations[c][h].partners[v].node.node.person=i[c][h].partners[v].person;var p=this.generations[c][h].partners[v].node.node.click;this.generations[c][h].partners[v].node.node.click(function(){p();this.toFront();this.text.toFront();X(this.person,this.active_partner,l)});d++}}}if(i[c][h].partners.length>0){if(i[c][h].partners.length>1){partner=i[c][h].active_partner.person}else{partner=i[c][h].partners[0].person}if(H(partner,i)>h){s="M "+(o+this.width)+" "+(u+this.height/2)+" h "+this.hDistance}else{}this.canvas.path(s).attr({"stroke-width":this.strokeWidth}).attr({stroke:this.strokeColor})}if(i[c][h].father){s="M "+(o+this.width/2)+" "+u+" v -"+this.vDistance/2;a=H(i[c][h].father,i);if(a===-1){a=H(i[c][h].mother,i)}s=s+" L "+(e[c-1]+(this.width+this.hDistance)*a+this.width+this.hDistance/2);s=s+" "+((c-1)*(this.vDistance+this.height)+20+this.height);s=s+" v -"+this.height/2}this.canvas.path(s).attr({"stroke-width":this.strokeWidth}).attr({stroke:this.strokeColor})}}}}